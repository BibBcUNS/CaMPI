<function name="bloquea_registro" tag="3000" split="occ">
<!-- Esta función bloquea el registro v3000^m, de la base v3000^b, por v3000^e segundos, con el lockid v3000^l 
Retorna en v3000 "ok" o el error de la operación
-->

	<field action="replace" tag="3000"><pft>if val(v3000^m)=0 then 'Error: Registro indefinido en ',v3000^b fi</pft></field>
	<flow action="skip"><pft>if val(v3000^m)=0 then 'Quit' fi</pft></flow> <!-- si no se define un mfn válido aborta -->
	
	<do task="update">
		<parm name="db"><pft>v3000^b</pft></parm>
		<parm name="mfn"><pft>v3000^m</pft></parm>
		<parm name="lockid"><pft>v3000^l</pft></parm>
		<parm name="expire"><pft>v3000^e</pft></parm>
  	<field action="define" tag="1102">Isis_Status</field>
  	<field action="define" tag="1103">Isis_RecordStatus</field>
  	<field action="define" tag="1011">Isis_Lock</field>
		<update>
			<write>lock</write>
			<field action="export" tag="list">1102,1103</field>
		</update>
		<field action="replace" tag="3000"><pft>if val(v1102)>0 or val(v1103)>0 then 'Error. Isis_Status',v1102,' Isis_RecordStatus: ',v1103 else 'ok' fi</pft></field>
		<return action="export" tag="list">3000</return>
	</do>
</function>

<function name="prestamos_asignados" tag="3000" split="occ">
<!-- Esta función busca los préstamos del usuario cuyo dni está definido en v3000.
Retorna en v3000 todos los préstamos con formato ^iInventario^bDNI^cFecha Préstamo^dFecha Vencimiento 
-->
	<do task="search">
		<parm name="db">exist</parm>
		<parm name="expression"><pft>'DNI=',v3000</pft></parm>
		<loop>
			<field action="replace" tag="998"><pft>'^i',v977,'^b',v998^b[LAST],'^c',v998^c[LAST],'^d',v998^d[LAST]</pft></field>
			<field action="export" tag="list" previous="add">998</field>
		</loop>
	</do>
	<return action="export" tag="3000">998</return>
</function>
